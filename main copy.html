<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Portfolio Manager - Combined View</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      margin: 0;
      display: flex;
      height: 100vh;
      font-family: sans-serif;
    }

    /* Left side: watchlist */
    #left {
      width: 50%;
      height: 100vh;
      border: none;
    }

    /* Right container: SMA + DCA */
    #right-container {
      width: 50%;
      display: flex;
      flex-direction: column;
      padding: 1rem;
      overflow-y: auto;
      background: #f9f9f9;
    }

    #strategy-frame {
      height: 50%;
      border: none;
    }

    #dca-section {
      flex: 1;
      margin-top: 1rem;
      background: #fff;
      padding: 1rem;
      border-radius: 0.5rem;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }

    input, button {
      padding: 0.5rem;
      font-size: 1rem;
      margin-top: 0.5rem;
    }

    canvas {
      max-width: 100%;
    }
  </style>
</head>
<body>

  <!-- Left: Watchlist (iframe) -->
  <iframe id="left" src="watchlist.html"></iframe>

  <!-- Right: SMA iframe + inline DCA -->
  <div id="right-container">
    <iframe id="strategy-frame" src="watchlist-strategy.html"></iframe>

    <div id="dca-section">
      <h2>DCA Strategy Visualizer</h2>
      <label for="symbol">Stock Symbol:</label>
      <input type="text" id="symbol" placeholder="e.g. AAPL" />
      <button onclick="fetchDCA()">Analyze</button>

      <div id="output" style="margin-top: 1rem;"></div>

      <canvas id="dcaChart" style="margin-top: 1.5rem;"></canvas>
    </div>
  </div>

  <script>
    async function fetchDCA() {
      const symbol = document.getElementById('symbol').value.trim().toUpperCase();
      if (!symbol) return alert("Please enter a stock symbol.");

      const res = await fetch(`/api/dca/${symbol}`);
      const data = await res.json();

      if (data.error) {
        document.getElementById('output').innerHTML = `<p style="color:red;">${data.error}</p>`;
        return;
      }

      const d = data.dca;
      document.getElementById('output').innerHTML = `
        <p><strong>Total Invested:</strong> $${d.totalInvested}</p>
        <p><strong>Total Shares:</strong> ${d.totalShares}</p>
        <p><strong>Average Cost per Share:</strong> $${d.averageCostPerShare}</p>
        <p><strong>Current Value:</strong> $${d.currentValue}</p>
        <p><strong>Gain/Loss:</strong> $${d.gainLoss} (${d.gainLossPercent}%)</p>
      `;

      const ctx = document.getElementById('dcaChart').getContext('2d');
      if (window.dcaChart) window.dcaChart.destroy();

      window.dcaChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: d.dates,
          datasets: [{
            label: 'Close Price',
            data: d.closes,
            borderColor: 'green',
            fill: false
          }]
        },
        options: {
          responsive: true,
          scales: {
            x: {
              title: { display: true, text: 'Date' },
              ticks: { maxTicksLimit: 15 }
            },
            y: {
              title: { display: true, text: 'Price (USD)' }
            }
          }
        }
      });
    }
  </script>
</body>
</html>
